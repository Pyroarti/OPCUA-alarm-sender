<!DOCTYPE html>
<html>
<head>
    <style>

        body {
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }


        h1 {
            font-size: 1.5em;
        }

        label, input {
            font-size: 1.2em;
        }

        label {
            display: inline-block;
            width: 100px;

        }


        input[type="text"] {
            width: 300px;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }

        input[type="filter_text"] {
            width: 500px;
            height: 30px;
            padding: 10px;
            margin-bottom: 20px;
            margin-left: 10px;
            font-size: large;
        }


        input[type="submit"] {
            width: 200px;
            height: 100px;
            font-size: 25px;
            margin-top: 10px;
            margin-left: 20px;
        }

        input[type="number"] {
            width: 200px;
            height: 30px;
            margin-bottom: 10px;
            margin-left: 100px;
            margin-right: 100px;
        }

        .update-button {
            background-color: #4CAF50;
            color: white;
        }

        .delete-button {
            background-color: red;
            color: white;
        }

        .time-input {
            font-size: 150%;
            width: 100px;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .checkbox {
            transform: scale(1.2);
            width: 1.5em;
            height: 1.5em;
            margin-bottom: 20px;

        }

        .button_back {
            background-color: #009afa;
            color: white;
            width: 200px;
            height: 100px;
            font-size: 25px;
            margin-top: 20px;
        }
        .button_add_setting {
            background-color: #009afa;
            color: white;
            width: 200px;
            height: 100px;
            font-size: 25px;
            margin-top: 10px;
        }

        .button_save_user {
            background-color: #009afa;
            color: white;
            width: 230px;
            height: 100px;
            font-size: 25px;
            margin-top: 10px;
        }

        .remove-time-setting {
            background-color: #ff4d4d;
            color: white;
            width: 15%;
            height: 50px;
            padding: 5px 10px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .helper-text {
            display: block;
            margin-bottom: 5px;
            margin-top: 30px;
            color: #6c757d;
            font-size: 1.0em;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Edit User</h1>
        <form method="post" action="{{ url_for('edit_user', id=user_id) }}" id="edit-user-form" onsubmit="return validateForm()">
            <!-- Name and Phone Number Inputs -->
            <label for="name">Namn:</label>
            <input type="text" id="name" name="name" value="{{ user.Name }}" required><br>
            <label for="phone_number">Telefon Nummer:</label>
            <input type="text" id="phone_number" name="phone_number" value="{{ user.phone_number }}" required><br>

            <!-- Time Settings -->
            <div id="time-settings-container">
                {% for setting in user.timeSettings %}
                <fieldset class="time-setting">
                    <legend>Filtrering {{ loop.index }}</legend>
                    <!-- Day Checkboxes -->
                    <div class="helper-text">Dagar i veckan då larmet ska skickas</div>
                    {% for day in ['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag', 'Söndag'] %}
                    <label>{{ day }}:</label>
                    <input type="checkbox" class="checkbox" name="days{{ loop.index }}[]" value="{{ day }}" {% if day in setting.days %} checked {% endif %}>
                    {% endfor %}

                    <!-- Whole Day Checkbox and Hidden Inputs -->
                    <label for="wholeDay{{ loop.index }}">Hela dagen:</label>
                    <input type="checkbox" class="checkbox" id="wholeDay{{ loop.index }}" name="wholeDay{{ loop.index }}" onchange="toggleTimeInputs(this, 1)" {% if setting.wholeDay %} checked {% endif %}><br>
                    <input type="hidden" id="hiddenStartTime{{ loop.index }}" name="hiddenStartTime{{ loop.index }}" value="{{ setting.startTime }}">
                    <input type="hidden" id="hiddenEndTime{{ loop.index }}" name="hiddenEndTime{{ loop.index }}" value="{{ setting.endTime }}">

                    <!-- Time Inputs -->
                    <label for="startTime{{ loop.index }}">Start tid:</label>
                    <input type="time" class="time-input" id="startTime{{ loop.index }}" name="startTime{{ loop.index }}" value="{{ setting.startTime }}" required><br>
                    <label for="endTime{{ loop.index }}">Slut tid:</label>
                    <input type="time" class="time-input" id="endTime{{ loop.index }}" name="endTime{{ loop.index }}" value="{{ setting.endTime }}" required><br>

                    <!-- Severity Inputs -->
                    <label for="lowestSeverity{{ loop.index }}">Lägsta allvarlighetsgrad:</label>
                    <input type="number" id="lowestSeverity{{ loop.index }}" name="lowestSeverity{{ loop.index }}" value="{{ setting.lowestSeverity }}" required><br>
                    <label for="highestSeverity{{ loop.index }}">Högsta allvarlighetsgrad:</label>
                    <input type="number" id="highestSeverity{{ loop.index }}" name="highestSeverity{{ loop.index }}" value="{{ setting.highestSeverity }}" required><br>

                    <!-- Keyword Filter Input -->
                    <div class="helper-text">Nyckelord filtrering:</div>
                    <label for="WordFilter{{ loop.index }}">Nyckelord:</label>
                    <input type="filter_text" id="WordFilter{{ loop.index }}" name="WordFilter{{ loop.index }}" value="{{ setting.wordFilter }}"><br>
                </fieldset>
                {% endfor %}
            </div>

            <button type="button" id="add-time-setting" class="button_add_setting" onclick="addTimeSetting()">Lägg till filtrering</button>
            <input type="submit" class="button_save_user" value="Spara Ändringar"><br>
            <button type="button" id="back" class="button_back" onclick="goBack()">Gå tillbaka</button>
        </form>
    </div>

    <script>

        var settingsCount = {{ user.timeSettings | length }};

        function addTimeSetting() {
            var container = document.getElementById('time-settings-container');
            var settingsCount = container.getElementsByClassName('time-setting').length;
            var newSetting = container.children[0].cloneNode(true);

            // Increment settingsCount for the new setting
            settingsCount++;

            // Update the legend to indicate the number for the new time setting
            newSetting.getElementsByTagName('legend')[0].textContent = 'Filtrering ' + settingsCount;

            var dayCheckboxes = newSetting.querySelectorAll('[name^="days1[]"]');
            dayCheckboxes.forEach(function(checkbox) {
                checkbox.name = 'days' + settingsCount + '[]';
                checkbox.checked = false;
            });

            // Update the IDs and names of the new setting's elements
            newSetting.id = 'timeSetting' + (settingsCount + 1);
            var wholeDayCheckbox = newSetting.querySelector('[id^="wholeDay"]');
            var startTimeInput = newSetting.querySelector('[id^="startTime"]');
            var endTimeInput = newSetting.querySelector('[id^="endTime"]');

            wholeDayCheckbox.id = 'wholeDay' + (settingsCount + 1);
            wholeDayCheckbox.name = 'wholeDay' + (settingsCount + 1);
            wholeDayCheckbox.onchange = function() { toggleTimeInputs(this, (settingsCount + 1)); };

            startTimeInput.id = 'startTime' + (settingsCount + 1);
            startTimeInput.name = 'startTime' + (settingsCount + 1);

            endTimeInput.id = 'endTime' + (settingsCount + 1);
            endTimeInput.name = 'endTime' + (settingsCount + 1);

            var lowestSeverityInput = newSetting.querySelector('[id^="lowestSeverity"]');
            var highestSeverityInput = newSetting.querySelector('[id^="highestSeverity"]');

            lowestSeverityInput.id = 'lowestSeverity' + (settingsCount + 1);
            lowestSeverityInput.name = 'lowestSeverity' + (settingsCount + 1);

            highestSeverityInput.id = 'highestSeverity' + (settingsCount + 1);
            highestSeverityInput.name = 'highestSeverity' + (settingsCount + 1);

            var WordFilter1 = newSetting.querySelector('[id^="WordFilter"]');
            WordFilter1.id = 'WordFilter' + (settingsCount + 1);
            WordFilter1.name = 'WordFilter' + (settingsCount + 1);

            var days = newSetting.querySelectorAll('[name^="days"]');
            for (var i = 0; i < days.length; i++) {
                days[i].checked = false;
            }

            startTimeInput.disabled = false;
            endTimeInput.disabled = false;
            startTimeInput.value = '';
            endTimeInput.value = '';
            wholeDayCheckbox.checked = false;
            lowestSeverityInput.value = '';
            highestSeverityInput.value = '';


            wholeDayCheckbox.onchange = function() { toggleTimeInputs(this, (settingsCount + 1)); };


            toggleTimeInputs(wholeDayCheckbox, settingsCount + 1);

            // Append the new setting to the container
            container.appendChild(newSetting);

            // Add a remove button to the new setting
            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.textContent = 'Ta bort filtrering';
            removeButton.className = 'remove-time-setting';
            removeButton.onclick = function() {
                container.removeChild(newSetting);
            };
            newSetting.appendChild(removeButton);
        }


        function goBack() {
            location.replace("{{ url_for('index') }}");
        }

        function toggleTimeInputs(checkbox, settingNumber) {
            var startTimeInput = document.getElementById('startTime' + settingNumber);
            var endTimeInput = document.getElementById('endTime' + settingNumber);
            var hiddenStartTimeInput = document.getElementById('hiddenStartTime' + settingNumber);
            var hiddenEndTimeInput = document.getElementById('hiddenEndTime' + settingNumber);

            if (checkbox.checked) {
                if (startTimeInput && endTimeInput) {
                    startTimeInput.value = '00:00';
                    endTimeInput.value = '23:59';
                }
                if (hiddenStartTimeInput && hiddenEndTimeInput) {
                    hiddenStartTimeInput.value = '00:00';
                    hiddenEndTimeInput.value = '23:59';
                }
            } else {
                if (startTimeInput && endTimeInput) {
                    startTimeInput.value = '';
                    endTimeInput.value = '';
                }
                if (hiddenStartTimeInput && hiddenEndTimeInput) {
                    hiddenStartTimeInput.value = '';
                    hiddenEndTimeInput.value = '';
                }
            }
        }


        function validateForm() {
            var timeSettingsContainer = document.getElementById('time-settings-container');
            var timeSettings = timeSettingsContainer.getElementsByClassName('time-setting');

            for (var i = 0; i < timeSettings.length; i++) {
                var timeSetting = timeSettings[i];
                var settingNumber = i + 1; // since your settings start with 1, not 0

                var lowestSeverityInput = document.getElementById('lowestSeverity' + settingNumber);
                var highestSeverityInput = document.getElementById('highestSeverity' + settingNumber);

                // Validate the severity range
                if (lowestSeverityInput.value < 0 || lowestSeverityInput.value > 1000) {
                    alert('Lägsta allvarlighetsgrad måste vara mellan 0 och 1000.');
                    return false;
                }

                if (highestSeverityInput.value < 0 || highestSeverityInput.value > 1000) {
                    alert('Högsta allvarlighetsgrad måste vara mellan 0 och 1000.');
                    return false;
                }

                // Validate that the lowest severity is less than the highest severity
                if (parseInt(lowestSeverityInput.value) >= parseInt(highestSeverityInput.value)) {
                    alert('Lägsta allvarlighetsgrad måste vara lägre än högsta allvarlighetsgrad.');
                    return false;
                }

                // Check that at least one day checkbox is checked
                var dayCheckboxes = timeSetting.querySelectorAll('[name^="days' + settingNumber + '[]"]');
                var oneDayChecked = Array.from(dayCheckboxes).some(checkbox => checkbox.checked);
                if (!oneDayChecked) {
                    alert('Välj minst en dag för Filtrering ' + settingNumber);
                    return false;
                }
            }

            return true;
        }



    </script>


</body>
</html>
